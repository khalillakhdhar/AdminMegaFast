<div class="container-fluid">
  <app-page-title [title]="client?.name || 'Détail Client'" [breadcrumbItems]="breadCrumbItems"></app-page-title>

  @if (loading) {
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-3 text-muted">Chargement des informations du client...</p>
          </div>
        </div>
      </div>
    </div>
  } @else if (client) {
    <div class="row">
      <!-- Left Column - Client Info -->
      <div class="col-xl-4">
        <!-- Client Profile Card -->
        <div class="card">
          <div class="bg-primary-subtle">
            <div class="row">
              <div class="col-7">
                <div class="text-primary p-3">
                  <h5 class="text-primary">Profil Client</h5>
                  <p>Informations détaillées</p>
                </div>
              </div>
              <div class="col-5 align-self-end">
                <img src="assets/images/profile-img.png" alt="" class="img-fluid">
              </div>
            </div>
          </div>
          <div class="card-body pt-0">
            <div class="row">
              <div class="col-sm-4">
                <div class="avatar-md profile-user-wid mb-4">
                  <div class="avatar-title bg-primary text-white rounded-circle font-size-20">
                    {{ client.name.charAt(0).toUpperCase() }}
                  </div>
                </div>
                <h5 class="font-size-15 text-truncate">{{ client.name }}</h5>
                <p class="text-muted mb-0 text-truncate">{{ client.company || 'Client particulier' }}</p>
              </div>

              <div class="col-sm-8">
                <div class="pt-4">
                  @if (clientStats && !loadingStats) {
                    <div class="row">
                      <div class="col-6">
                        <h5 class="font-size-15">{{ clientStats.totalOrders }}</h5>
                        <p class="text-muted mb-0">Commandes</p>
                      </div>
                      <div class="col-6">
                        <h5 class="font-size-15">{{ formatCurrency(clientStats.totalValue) }}</h5>
                        <p class="text-muted mb-0">Valeur totale</p>
                      </div>
                    </div>
                  }
                  <div class="mt-4">
                    <span [class]="getStatusClass()">{{ getStatusText() }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Personal Information -->
        <div class="card">
          <div class="card-body">
            <h4 class="card-title mb-4">Informations Personnelles</h4>

            @if (client.notes) {
              <p class="text-muted mb-4">{{ client.notes.split('\n')[0] }}</p>
            }

            <div class="table-responsive">
              <table class="table table-nowrap mb-0">
                <tbody>
                  @if (client.email) {
                    <tr>
                      <th scope="row">Email :</th>
                      <td>{{ client.email }}</td>
                    </tr>
                  }
                  @if (client.phone) {
                    <tr>
                      <th scope="row">Téléphone :</th>
                      <td>{{ client.phone }}</td>
                    </tr>
                  }
                  @if (client.vatNumber) {
                    <tr>
                      <th scope="row">Matricule fiscal :</th>
                      <td>{{ client.vatNumber }}</td>
                    </tr>
                  }
                  <tr>
                    <th scope="row">Date création :</th>
                    <td>{{ client.createdAt?.toDate?.() || client.createdAt | date:'dd/MM/yyyy' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Address Card -->
        @if (client.address && (client.address.line1 || client.address.city)) {
          <div class="card">
            <div class="card-body">
              <h4 class="card-title mb-4">Adresse</h4>
              <div class="text-muted">
                @if (client.address.line1) {
                  <p class="mb-1">{{ client.address.line1 }}</p>
                }
                @if (client.address.line2) {
                  <p class="mb-1">{{ client.address.line2 }}</p>
                }
                @if (client.address.city || client.address.postalCode) {
                  <p class="mb-1">
                    {{ client.address.postalCode }}{{ client.address.postalCode && client.address.city ? ' ' : '' }}{{ client.address.city }}
                  </p>
                }
                @if (client.address.delegation) {
                  <p class="mb-1">{{ client.address.delegation }}</p>
                }
                @if (client.address.country) {
                  <p class="mb-0">{{ client.address.country }}</p>
                }
              </div>
            </div>
          </div>
        }

        <!-- Actions Card -->
        <div class="card">
          <div class="card-body">
            <h4 class="card-title mb-4">Actions</h4>
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-primary" (click)="openEditModal()">
                <i class="bx bx-edit-alt me-1"></i> Modifier
              </button>
              <button type="button" class="btn btn-info" (click)="openAddNoteModal()">
                <i class="bx bx-note me-1"></i> Ajouter une note
              </button>
              <button type="button" class="btn btn-secondary" (click)="exportClientData()">
                <i class="bx bx-download me-1"></i> Exporter
              </button>
              <button type="button"
                      [class]="client.isActive !== false ? 'btn btn-warning' : 'btn btn-success'"
                      (click)="toggleClientStatus()">
                <i [class]="client.isActive !== false ? 'bx bx-pause' : 'bx bx-play'"></i>
                {{ client.isActive !== false ? ' Désactiver' : ' Activer' }}
              </button>
              <button type="button" class="btn btn-danger" (click)="deleteClient()">
                <i class="bx bx-trash me-1"></i> Supprimer
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Stats & Orders -->
      <div class="col-xl-8">
        @if (clientStats && !loadingStats) {
          <!-- Statistics Cards -->
          <div class="row">
            <div class="col-md-4">
              <div class="card mini-stats-wid">
                <div class="card-body">
                  <div class="d-flex">
                    <div class="flex-grow-1">
                      <p class="text-muted fw-medium">Total Commandes</p>
                      <h4 class="mb-0">{{ clientStats.totalOrders }}</h4>
                    </div>
                    <div class="avatar-sm rounded-circle bg-primary align-self-center">
                      <span class="avatar-title rounded-circle bg-primary">
                        <i class="bx bx-shopping-bag font-size-20"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card mini-stats-wid">
                <div class="card-body">
                  <div class="d-flex">
                    <div class="flex-grow-1">
                      <p class="text-muted fw-medium">Valeur Moyenne</p>
                      <h4 class="mb-0">{{ formatCurrency(clientStats.avgOrderValue) }}</h4>
                    </div>
                    <div class="avatar-sm rounded-circle bg-primary align-self-center">
                      <span class="avatar-title rounded-circle bg-primary">
                        <i class="bx bx-money font-size-20"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card mini-stats-wid">
                <div class="card-body">
                  <div class="d-flex">
                    <div class="flex-grow-1">
                      <p class="text-muted fw-medium">Dernière Commande</p>
                      <h4 class="mb-0 font-size-14">
                        {{ clientStats.lastOrderDate | date:'dd/MM/yy' }}
                      </h4>
                    </div>
                    <div class="avatar-sm rounded-circle bg-primary align-self-center">
                      <span class="avatar-title rounded-circle bg-primary">
                        <i class="bx bx-calendar font-size-20"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="row">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title mb-4">Évolution des Commandes</h4>
                  <apx-chart
                    [series]="ordersChartOptions.series"
                    [chart]="ordersChartOptions.chart"
                    [xaxis]="ordersChartOptions.xaxis"
                    [yaxis]="ordersChartOptions.yaxis"
                    [colors]="ordersChartOptions.colors"
                    [stroke]="ordersChartOptions.stroke"
                    [markers]="ordersChartOptions.markers"
                    [grid]="ordersChartOptions.grid">
                  </apx-chart>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title mb-4">Chiffre d'Affaires</h4>
                  <apx-chart
                    [series]="revenueChartOptions.series"
                    [chart]="revenueChartOptions.chart"
                    [xaxis]="revenueChartOptions.xaxis"
                    [yaxis]="revenueChartOptions.yaxis"
                    [colors]="revenueChartOptions.colors"
                    [fill]="revenueChartOptions.fill"
                    [stroke]="revenueChartOptions.stroke"
                    [grid]="revenueChartOptions.grid">
                  </apx-chart>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Orders -->
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-4">
                <h4 class="card-title mb-0">Commandes Récentes</h4>
                <a href="#" class="btn btn-light btn-sm">Voir tout</a>
              </div>
              <div class="table-responsive">
                <table class="table table-nowrap table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>N° Commande</th>
                      <th>Date</th>
                      <th>Montant</th>
                      <th>Articles</th>
                      <th>Statut</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (order of clientStats.recentOrders; track order.id) {
                      <tr>
                        <td>
                          <h6 class="mb-0">{{ order.id }}</h6>
                        </td>
                        <td>{{ order.date | date:'dd/MM/yyyy' }}</td>
                        <td>{{ formatCurrency(order.amount) }}</td>
                        <td>{{ order.items }}</td>
                        <td>
                          <span [class]="getOrderStatusClass(order.status)">
                            {{ getOrderStatusText(order.status) }}
                          </span>
                        </td>
                        <td>
                          <button type="button" class="btn btn-light btn-sm">
                            <i class="bx bx-show"></i>
                          </button>
                        </td>
                      </tr>
                    } @empty {
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <div class="text-muted">
                            <i class="bx bx-package font-size-24 d-block mb-2"></i>
                            Aucune commande trouvée
                          </div>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        } @else if (loadingStats) {
          <div class="card">
            <div class="card-body text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement des statistiques...</span>
              </div>
              <p class="mt-3 text-muted">Chargement des statistiques...</p>
            </div>
          </div>
        }
      </div>
    </div>
  } @else {
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="bx bx-error-circle font-size-48 text-danger mb-3"></i>
            <h4>Client non trouvé</h4>
            <p class="text-muted">Le client demandé n'existe pas ou a été supprimé.</p>
            <a routerLink="/clients" class="btn btn-primary">Retour à la liste</a>
          </div>
        </div>
      </div>
    </div>
  }
</div>

<!-- Modal Edit Client -->
<ng-template #editClientModal>
  <div class="modal-header">
    <h5 class="modal-title">Modifier le client</h5>
    <button type="button" class="btn-close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="clientForm" (ngSubmit)="saveClient()">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="editClientName" class="form-label">Nom <span class="text-danger">*</span></label>
            <input type="text" id="editClientName" class="form-control" formControlName="name"
                   placeholder="Nom du client"
                   [class.is-invalid]="clientForm.get('name')?.invalid && clientForm.get('name')?.touched">
            @if (clientForm.get('name')?.invalid && clientForm.get('name')?.touched) {
              <div class="invalid-feedback">Le nom est requis</div>
            }
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="editClientEmail" class="form-label">Email</label>
            <input type="email" id="editClientEmail" class="form-control" formControlName="email"
                   placeholder="email@exemple.com"
                   [class.is-invalid]="clientForm.get('email')?.invalid && clientForm.get('email')?.touched">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="editClientPhone" class="form-label">Téléphone</label>
            <input type="tel" id="editClientPhone" class="form-control" formControlName="phone" placeholder="+216 XX XXX XXX">
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="editClientCompany" class="form-label">Entreprise</label>
            <input type="text" id="editClientCompany" class="form-control" formControlName="company" placeholder="Nom de l'entreprise">
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="editClientVatNumber" class="form-label">Matricule Fiscal</label>
        <input type="text" id="editClientVatNumber" class="form-control" formControlName="vatNumber" placeholder="1234567/A/M/000">
      </div>

      <div class="mb-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="editClientActive" formControlName="isActive">
          <label class="form-check-label" for="editClientActive">
            Client actif
          </label>
        </div>
      </div>

      <div class="text-end">
        <button type="button" class="btn btn-light me-2" (click)="modalRef?.hide()">
          Annuler
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="clientForm.invalid">
          Modifier
        </button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Modal Add Note -->
<ng-template #addNoteModal>
  <div class="modal-header">
    <h5 class="modal-title">Ajouter une note</h5>
    <button type="button" class="btn-close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="noteForm" (ngSubmit)="addNote()">
      <div class="mb-3">
        <label for="noteText" class="form-label">Note <span class="text-danger">*</span></label>
        <textarea id="noteText" class="form-control" rows="4" formControlName="note"
                  placeholder="Ajoutez votre note ici..."
                  [class.is-invalid]="noteForm.get('note')?.invalid && noteForm.get('note')?.touched"></textarea>
        @if (noteForm.get('note')?.invalid && noteForm.get('note')?.touched) {
          <div class="invalid-feedback">La note est requise (min. 5 caractères)</div>
        }
      </div>

      <div class="text-end">
        <button type="button" class="btn btn-light me-2" (click)="modalRef?.hide()">
          Annuler
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="noteForm.invalid">
          Ajouter
        </button>
      </div>
    </form>
  </div>
</ng-template>
