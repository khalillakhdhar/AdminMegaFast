<div class="container-fluid">
	<app-page-title title="Créer un Colis" [breadcrumbItems]="breadCrumbItems"></app-page-title>

	<div class="card">
		<div class="card-body">
			<form [formGroup]="form" novalidate (ngSubmit)="submit(false)">

				<!-- Wizard steps nav -->
				<ul class="nav nav-pills nav-justified mb-4" aria-label="Étapes création colis">
					<li class="nav-item">
						<button class="nav-link" [class.active]="step===1" type="button" (click)="goToStep(1)">Client Expéditeur</button>
					</li>
					<li class="nav-item">
						<button class="nav-link" [class.active]="step===2" type="button" (click)="goToStep(2)">Destinataire</button>
					</li>
					<li class="nav-item">
						<button class="nav-link" [class.active]="step===3" type="button" (click)="goToStep(3)">Produits</button>
					</li>
					<li class="nav-item">
						<button class="nav-link" [class.active]="step===4" type="button" (click)="goToStep(4)">Livraison & Frais</button>
					</li>
					<li class="nav-item">
						<button class="nav-link" [class.active]="step===5" type="button" (click)="goToStep(5)">Lot & Livreur</button>
					</li>
					<li class="nav-item">
						<button class="nav-link" [class.active]="step===6" type="button" (click)="goToStep(6)">Récapitulatif</button>
					</li>
				</ul>

				<!-- Step 1: Client Expéditeur -->
				<div [hidden]="step!==1">
					<h5 class="text-primary mb-3">
						<i class="bx bx-user me-2"></i>
						Client Expéditeur
					</h5>

					<!-- Mode de sélection client -->
					<div class="row g-3 mb-4">
						<div class="col-12">
							<label class="form-label">Mode de sélection client</label>
							<div class="btn-group w-100" role="group">
								<input type="radio" class="btn-check" name="clientMode" id="modeExisting"
									   value="existing" formControlName="clientMode" (change)="onClientModeChange('existing')">
								<label class="btn btn-outline-primary" for="modeExisting">
									<i class="bx bx-search me-1"></i>
									Client existant
								</label>

								<input type="radio" class="btn-check" name="clientMode" id="modeNew"
									   value="new" formControlName="clientMode" (change)="onClientModeChange('new')">
								<label class="btn btn-outline-primary" for="modeNew">
									<i class="bx bx-plus me-1"></i>
									Nouveau client
								</label>
							</div>
						</div>
					</div>

					<!-- Sélection client existant -->
					<div class="row g-3 mb-4" *ngIf="clientMode === 'existing'">
						<div class="col-12">
							<label class="form-label">Rechercher un client existant</label>
							<ng-select
								[items]="clients"
								[clearable]="true"
								bindLabel="name"
								placeholder="Rechercher et sélectionner un client..."
								(change)="onClientSelect($event)"
								[typeahead]="true">
								<ng-option *ngFor="let client of clients" [value]="client">
									<div>
										<strong>{{ client.name }}</strong>
										<small class="text-muted d-block">{{ client.phone }} - {{ client.email }}</small>
										<small class="text-muted" *ngIf="client.company">{{ client.company }}</small>
									</div>
								</ng-option>
							</ng-select>
							<button
								*ngIf="selectedClient"
								type="button"
								class="btn btn-sm btn-outline-secondary mt-2"
								(click)="clearClientSelection()">
								<i class="bx bx-x me-1"></i>
								Effacer la sélection
							</button>
						</div>
					</div>

					<!-- Informations client -->
					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label" for="clientName">Nom du client <span class="text-danger">*</span></label>
							<input type="text" formControlName="clientName" id="clientName" class="form-control"
								   placeholder="Nom complet du client" [readonly]="clientMode === 'existing' && selectedClient">
							<div class="invalid-feedback d-block" *ngIf="form.get('clientName')?.invalid && form.get('clientName')?.touched">
								Le nom du client est requis (minimum 2 caractères)
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="clientPhone">Téléphone <span class="text-danger">*</span></label>
							<input type="tel" formControlName="clientPhone" id="clientPhone" class="form-control"
								   placeholder="Numéro de téléphone" [readonly]="clientMode === 'existing' && selectedClient">
							<div class="invalid-feedback d-block" *ngIf="form.get('clientPhone')?.invalid && form.get('clientPhone')?.touched">
								Le téléphone du client est requis (minimum 6 caractères)
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="clientEmail">Email</label>
							<input type="email" formControlName="clientEmail" id="clientEmail" class="form-control"
								   placeholder="Adresse email" [readonly]="clientMode === 'existing' && selectedClient">
						</div>
						<div class="col-md-6">
							<label class="form-label" for="clientCompany">Société</label>
							<input type="text" formControlName="clientCompany" id="clientCompany" class="form-control"
								   placeholder="Nom de la société" [readonly]="clientMode === 'existing' && selectedClient">
						</div>
					</div>

					<hr class="my-4">

					<!-- Adresse de récupération -->
					<h6 class="text-primary mb-3">
						<i class="bx bx-package me-1"></i>
						Adresse de récupération
					</h6>
					<div class="row g-3">
						<div class="col-12">
							<label class="form-label" for="pickupAddress">Adresse de récupération <span class="text-danger">*</span></label>
							<textarea formControlName="pickupAddress" id="pickupAddress" class="form-control" rows="2"
								      placeholder="Adresse complète de récupération du colis"></textarea>
							<div class="invalid-feedback d-block" *ngIf="form.get('pickupAddress')?.invalid && form.get('pickupAddress')?.touched">
								L'adresse de récupération est requise (minimum 3 caractères)
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="pickupGovernorate">Gouvernorat de récupération <span class="text-danger">*</span></label>
							<select formControlName="pickupGovernorate" id="pickupGovernorate" class="form-select" (change)="onPickupGovernorateChange($event)">
								<option value="">Sélectionner un gouvernorat</option>
								<option *ngFor="let gov of pickupGovernorates" [value]="gov.code">{{ gov.name }} ({{ gov.arabicName }})</option>
							</select>
							<div class="invalid-feedback d-block" *ngIf="form.get('pickupGovernorate')?.invalid && form.get('pickupGovernorate')?.touched">
								Le gouvernorat de récupération est requis
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="pickupDelegation">Délégation de récupération</label>
							<select formControlName="pickupDelegation" id="pickupDelegation" class="form-select" [disabled]="pickupDelegations.length === 0">
								<option value="">Sélectionner une délégation</option>
								<option *ngFor="let del of pickupDelegations" [value]="del.code">{{ del.name }} ({{ del.arabicName }})</option>
							</select>
						</div>
					</div>

					<div class="d-flex justify-content-end mt-4">
						<button type="button" class="btn btn-primary"
							(click)="next()"
							[disabled]="form.get('clientName')?.invalid || form.get('clientPhone')?.invalid || form.get('pickupAddress')?.invalid || form.get('pickupGovernorate')?.invalid">
							Suivant : Destinataire
						</button>
					</div>
				</div>

				<!-- Step 2: Destinataire -->
				<div [hidden]="step!==2">
					<h5 class="text-primary mb-3">
						<i class="bx bx-map-pin me-2"></i>
						Informations du Destinataire
					</h5>

					<!-- Informations personnelles du destinataire -->
					<div class="row g-3 mb-4">
						<div class="col-md-6">
							<label class="form-label" for="recipientName">Nom du destinataire <span class="text-danger">*</span></label>
							<input type="text" formControlName="recipientName" id="recipientName" class="form-control"
								   placeholder="Nom complet du destinataire">
							<div class="invalid-feedback d-block" *ngIf="form.get('recipientName')?.invalid && form.get('recipientName')?.touched">
								Le nom du destinataire est requis (minimum 2 caractères)
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="recipientPhone">Téléphone <span class="text-danger">*</span></label>
							<input type="tel" formControlName="recipientPhone" id="recipientPhone" class="form-control"
								   placeholder="Numéro de téléphone du destinataire">
							<div class="invalid-feedback d-block" *ngIf="form.get('recipientPhone')?.invalid && form.get('recipientPhone')?.touched">
								Le téléphone du destinataire est requis (minimum 6 caractères)
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="recipientEmail">Email</label>
							<input type="email" formControlName="recipientEmail" id="recipientEmail" class="form-control"
								   placeholder="Adresse email du destinataire">
						</div>
						<div class="col-md-6">
							<label class="form-label" for="recipientCompany">Société</label>
							<input type="text" formControlName="recipientCompany" id="recipientCompany" class="form-control"
								   placeholder="Nom de la société du destinataire">
						</div>
					</div>

					<!-- Adresse de livraison -->
					<h6 class="text-primary mb-3">
						<i class="bx bx-home me-1"></i>
						Adresse de livraison
					</h6>
					<div class="row g-3">
						<div class="col-12">
							<label class="form-label" for="recipientAddressLine1">Adresse principale <span class="text-danger">*</span></label>
							<input type="text" formControlName="recipientAddressLine1" id="recipientAddressLine1" class="form-control"
								   placeholder="Rue, avenue, boulevard...">
							<div class="invalid-feedback d-block" *ngIf="form.get('recipientAddressLine1')?.invalid && form.get('recipientAddressLine1')?.touched">
								L'adresse principale est requise (minimum 3 caractères)
							</div>
						</div>
						<div class="col-12">
							<label class="form-label" for="recipientAddressLine2">Complément d'adresse</label>
							<input type="text" formControlName="recipientAddressLine2" id="recipientAddressLine2" class="form-control"
								   placeholder="Appartement, étage, bâtiment... (optionnel)">
						</div>
						<div class="col-md-6">
							<label class="form-label" for="recipientGovernorate">Gouvernorat <span class="text-danger">*</span></label>
							<select formControlName="recipientGovernorate" id="recipientGovernorate" class="form-select" (change)="onRecipientGovernorateChange($event)">
								<option value="">Sélectionner un gouvernorat</option>
								<option *ngFor="let gov of deliveryGovernorates" [value]="gov.code">{{ gov.name }} ({{ gov.arabicName }})</option>
							</select>
							<div class="invalid-feedback d-block" *ngIf="form.get('recipientGovernorate')?.invalid && form.get('recipientGovernorate')?.touched">
								Le gouvernorat est requis
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="recipientDelegation">Délégation</label>
							<select formControlName="recipientDelegation" id="recipientDelegation" class="form-select" [disabled]="deliveryDelegations.length === 0">
								<option value="">Sélectionner une délégation</option>
								<option *ngFor="let del of deliveryDelegations" [value]="del.code">{{ del.name }} ({{ del.arabicName }})</option>
							</select>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="recipientPostalCode">Code postal</label>
							<input type="text" formControlName="recipientPostalCode" id="recipientPostalCode" class="form-control"
								   placeholder="Code postal">
						</div>
						<div class="col-md-6">
							<label class="form-label" for="recipientNotes">Notes sur la livraison</label>
							<input type="text" formControlName="recipientNotes" id="recipientNotes" class="form-control"
								   placeholder="Instructions spéciales...">
						</div>
					</div>

					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-light" (click)="prev()">Précédent</button>
						<button type="button" class="btn btn-primary" (click)="next()"
							[disabled]="form.get('recipientName')?.invalid || form.get('recipientPhone')?.invalid || form.get('recipientAddressLine1')?.invalid || form.get('recipientGovernorate')?.invalid">
							Suivant : Produits
						</button>
					</div>
				</div>

				<!-- Step 3: Products -->
				<div [hidden]="step!==3">
					<h5 class="text-primary mb-3">
						<i class="bx bx-package me-2"></i>
						Produits à expédier
					</h5>
					<div class="table-responsive">
						<table class="table table-striped">
							<thead>
								<tr>
									<th>Produit <span class="text-danger">*</span></th>
									<th>Quantité <span class="text-danger">*</span></th>
									<th>Prix unitaire <span class="text-danger">*</span></th>
									<th>Poids unitaire (kg)</th>
									<th>Total</th>
									<th></th>
								</tr>
							</thead>
							<tbody formArrayName="items">
								<tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
									<td><input type="text" formControlName="name" class="form-control" placeholder="Nom du produit"></td>
									<td><input type="number" formControlName="qty" class="form-control" placeholder="1" min="1"></td>
									<td><input type="number" formControlName="unitPrice" class="form-control" placeholder="0.00" step="0.01" min="0"></td>
									<td><input type="number" formControlName="unitWeight" class="form-control" placeholder="0.0" step="0.1" min="0"></td>
									<td class="align-middle">{{ (item.value.qty * item.value.unitPrice) | number:'1.2-2' }} TND</td>
									<td class="col-actions"><button type="button" class="btn btn-link text-danger" (click)="removeItem(i)" [disabled]="items.length===1"><i class="bx bx-trash"></i></button></td>
								</tr>
							</tbody>
						</table>
					</div>

					<div class="d-flex justify-content-between align-items-center mb-3">
						<button type="button" class="btn btn-light" (click)="addItem()">
							<i class="bx bx-plus"></i> Ajouter produit
						</button>
						<div class="text-end">
							<div class="fw-bold text-primary fs-5">
								Sous-total : {{ subtotal | number:'1.2-2' }} TND
							</div>
						</div>
					</div>

					<div class="row mt-3">
						<div class="col-md-4">
							<label class="form-label" for="weight">Poids total (kg)</label>
							<input type="number" formControlName="weight" id="weight" class="form-control" placeholder="0.0" step="0.1" min="0">
							<small class="text-muted">Le poids sera calculé automatiquement si non spécifié</small>
						</div>
					</div>

					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-light" (click)="prev()">Précédent</button>
						<button type="button" class="btn btn-primary" (click)="next()">Suivant : Livraison</button>
					</div>
				</div>

				<!-- Step 4: Delivery & Fees -->
				<div [hidden]="step!==4">
					<h5 class="text-primary mb-3">
						<i class="bx bx-credit-card me-2"></i>
						Livraison & Frais
					</h5>
					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label" for="paymentMode">Mode de paiement</label>
							<select formControlName="paymentMode" id="paymentMode" class="form-select">
								<option value="prepaid">Prépayé</option>
								<option value="cod">À la livraison (COD)</option>
							</select>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="amount">Montant à encaisser (TND)</label>
							<input type="number" formControlName="amount" id="amount" class="form-control" placeholder="0.00" step="0.01" min="0">
							<small class="text-muted">Montant que le destinataire doit payer</small>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="deliveryFee">Frais de livraison (TND) <span class="text-danger">*</span></label>
							<input type="number" formControlName="deliveryFee" id="deliveryFee" class="form-control" placeholder="0.00" step="0.01" min="0">
						</div>
						<div class="col-12">
							<label class="form-label" for="notes">Notes supplémentaires</label>
							<textarea formControlName="notes" id="notes" class="form-control" rows="3"
								      placeholder="Instructions spéciales, commentaires..."></textarea>
						</div>
					</div>

					<div class="alert alert-info mt-3">
						<div class="d-flex justify-content-between">
							<span><strong>Sous-total produits:</strong></span>
							<span>{{ subtotal | number:'1.2-2' }} TND</span>
						</div>
						<div class="d-flex justify-content-between">
							<span><strong>Frais de livraison:</strong></span>
							<span>{{ form.get('deliveryFee')?.value | number:'1.2-2' }} TND</span>
						</div>
						<hr>
						<div class="d-flex justify-content-between fw-bold text-primary">
							<span><strong>Total:</strong></span>
							<span>{{ grandTotal | number:'1.2-2' }} TND</span>
						</div>
					</div>

					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-light" (click)="prev()">Précédent</button>
						<button type="button" class="btn btn-primary" (click)="next()">Suivant : Lot & Livreur</button>
					</div>
				</div>

				<!-- Step 5: Batch & Driver -->
				<div [hidden]="step!==5">
					<h5 class="text-primary mb-3">
						<i class="bx bx-group me-2"></i>
						Attribution de lot et livreur
					</h5>
					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label" for="batchId">Lot d'expédition</label>
							<select formControlName="batchId" id="batchId" class="form-select">
								<option value="">Aucun lot (assignation automatique)</option>
								<option *ngFor="let batch of batches" [value]="batch.id">{{ batch.name }}</option>
							</select>
							<small class="text-muted">Le colis peut être assigné à un lot existant</small>
						</div>
						<div class="col-md-6">
							<label class="form-label" for="driverId">Livreur</label>
							<select formControlName="driverId" id="driverId" class="form-select">
								<option value="">Pas de livreur assigné</option>
								<option *ngFor="let driver of drivers" [value]="driver.uid">{{ driver.displayName }}</option>
							</select>
							<small class="text-muted">Le livreur peut être assigné plus tard</small>
						</div>
					</div>
					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-light" (click)="prev()">Précédent</button>
						<button type="button" class="btn btn-primary" (click)="next()">Suivant : Récapitulatif</button>
					</div>
				</div>

				<!-- Step 6: Summary -->
				<div [hidden]="step!==6">
					<h5 class="text-primary mb-3">
						<i class="bx bx-check-circle me-2"></i>
						Récapitulatif du colis
					</h5>

					<div class="row">
						<div class="col-lg-6">
							<!-- Client expéditeur -->
							<div class="card mb-3">
								<div class="card-header bg-light">
									<h6 class="mb-0"><i class="bx bx-user me-1"></i> Client Expéditeur</h6>
								</div>
								<div class="card-body">
									<div><strong>{{ form.get('clientName')?.value }}</strong></div>
									<div class="text-muted">{{ form.get('clientPhone')?.value }}</div>
									<div class="text-muted" *ngIf="form.get('clientEmail')?.value">{{ form.get('clientEmail')?.value }}</div>
									<div class="text-muted" *ngIf="form.get('clientCompany')?.value">{{ form.get('clientCompany')?.value }}</div>

									<hr class="my-2">
									<div class="small">
										<strong>Adresse de récupération:</strong><br>
										{{ form.get('pickupAddress')?.value }}<br>
										<strong>{{ selectedPickupGovernorate?.name || 'Gouvernorat non sélectionné' }}</strong>
										<span *ngIf="form.get('pickupDelegation')?.value && pickupDelegations.length > 0">
											- {{ getPickupDelegationName(form.get('pickupDelegation')?.value) }}
										</span>
									</div>
								</div>
							</div>

							<!-- Destinataire -->
							<div class="card mb-3">
								<div class="card-header bg-light">
									<h6 class="mb-0"><i class="bx bx-map-pin me-1"></i> Destinataire</h6>
								</div>
								<div class="card-body">
									<div><strong>{{ form.get('recipientName')?.value }}</strong></div>
									<div class="text-muted">{{ form.get('recipientPhone')?.value }}</div>
									<div class="text-muted" *ngIf="form.get('recipientEmail')?.value">{{ form.get('recipientEmail')?.value }}</div>
									<div class="text-muted" *ngIf="form.get('recipientCompany')?.value">{{ form.get('recipientCompany')?.value }}</div>

									<hr class="my-2">
									<div class="small">
										<strong>Adresse de livraison:</strong><br>
										{{ form.get('recipientAddressLine1')?.value }}
										<span *ngIf="form.get('recipientAddressLine2')?.value">, {{ form.get('recipientAddressLine2')?.value }}</span><br>
										<strong>{{ selectedDeliveryGovernorate?.name || 'Gouvernorat non sélectionné' }}</strong>
										<span *ngIf="form.get('recipientDelegation')?.value && deliveryDelegations.length > 0">
											- {{ getDeliveryDelegationName(form.get('recipientDelegation')?.value) }}
										</span>
										<span *ngIf="form.get('recipientPostalCode')?.value"> - {{ form.get('recipientPostalCode')?.value }}</span>
									</div>
									<div class="small text-info mt-2" *ngIf="form.get('recipientNotes')?.value">
										<strong>Notes:</strong> {{ form.get('recipientNotes')?.value }}
									</div>
								</div>
							</div>
						</div>

						<div class="col-lg-6">
							<!-- Produits -->
							<div class="card mb-3">
								<div class="card-header bg-light">
									<h6 class="mb-0"><i class="bx bx-package me-1"></i> Produits</h6>
								</div>
								<div class="card-body">
									<ul class="list-unstyled mb-2">
										<li *ngFor="let g of items.controls" class="d-flex justify-content-between">
											<span>{{ g.value.qty }} x {{ g.value.name }}</span>
											<span>{{ (g.value.qty*g.value.unitPrice) | number:'1.2-2' }} TND</span>
										</li>
									</ul>
									<hr>
									<div class="d-flex justify-content-between">
										<span>Sous-total:</span>
										<span>{{ subtotal | number:'1.2-2' }} TND</span>
									</div>
									<div class="d-flex justify-content-between">
										<span>Poids total:</span>
										<span>{{ form.get('weight')?.value }} kg</span>
									</div>
								</div>
							</div>

							<!-- Frais et paiement -->
							<div class="card mb-3">
								<div class="card-header bg-light">
									<h6 class="mb-0"><i class="bx bx-credit-card me-1"></i> Frais & Paiement</h6>
								</div>
								<div class="card-body">
									<div class="d-flex justify-content-between">
										<span>Mode de paiement:</span>
										<span class="badge bg-info">{{ form.get('paymentMode')?.value === 'cod' ? 'À la livraison' : 'Prépayé' }}</span>
									</div>
									<div class="d-flex justify-content-between mt-2" *ngIf="form.get('paymentMode')?.value === 'cod'">
										<span>Montant à encaisser:</span>
										<span>{{ form.get('amount')?.value | number:'1.2-2' }} TND</span>
									</div>
									<div class="d-flex justify-content-between mt-2">
										<span>Frais de livraison:</span>
										<span>{{ form.get('deliveryFee')?.value | number:'1.2-2' }} TND</span>
									</div>
									<hr>
									<div class="d-flex justify-content-between fw-bold text-primary">
										<span>Total frais:</span>
										<span>{{ form.get('deliveryFee')?.value | number:'1.2-2' }} TND</span>
									</div>
								</div>
							</div>

							<!-- Notes supplémentaires -->
							<div class="card" *ngIf="form.get('notes')?.value">
								<div class="card-header bg-light">
									<h6 class="mb-0"><i class="bx bx-note me-1"></i> Notes</h6>
								</div>
								<div class="card-body">
									<p class="mb-0">{{ form.get('notes')?.value }}</p>
								</div>
							</div>
						</div>
					</div>

					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-light" (click)="prev()">Précédent</button>
						<div>
							<button type="button" class="btn btn-outline-primary me-2" (click)="submit(true)" [disabled]="saving">
								<span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
								<i class="bx bx-printer me-1"></i>
								Créer & Imprimer
							</button>
							<button type="submit" class="btn btn-primary" [disabled]="saving">
								<span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
								<i class="bx bx-check me-1"></i>
								Créer le colis
							</button>
						</div>
					</div>
				</div>

			</form>
		</div>
	</div>
</div>
