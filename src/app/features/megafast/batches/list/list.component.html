<div class="container-fluid">
  <!-- Page Title -->
  <app-page-title title="Gestion des Lots" [breadcrumbItems]="breadCrumbItems"></app-page-title>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">Total Lots</p>
              <h4 class="mb-0">{{stats.totalBatches}}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle bg-primary">
                <span class="avatar-title">
                  <i class="bx bx-package font-size-16"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">En cours</p>
              <h4 class="mb-0">{{stats.inProgressBatches}}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle bg-info">
                <span class="avatar-title">
                  <i class="bx bx-truck font-size-16"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">Terminés</p>
              <h4 class="mb-0">{{stats.completedBatches}}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle bg-success">
                <span class="avatar-title">
                  <i class="bx bx-check font-size-16"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">COD Total</p>
              <h4 class="mb-0">{{stats.totalAmount | currency:'TND'}}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle bg-warning">
                <span class="avatar-title">
                  <i class="bx bx-dollar font-size-16"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <form [formGroup]="filterForm" class="row g-3">
            <div class="col-md-3">
              <label class="form-label" for="code">Code lot</label>
              <input type="text" id="code" class="form-control" formControlName="code" placeholder="Rechercher...">
            </div>
            <div class="col-md-3">
              <label class="form-label" for="status">Statut</label>
              <ng-select id="status" formControlName="status" placeholder="Tous les statuts" [clearable]="true">
                <ng-option *ngFor="let status of statusOptions" [value]="status.value">
                  {{status.label}}
                </ng-option>
              </ng-select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="assignedTo">Livreur</label>
              <ng-select id="assignedTo" formControlName="assignedTo" placeholder="Tous les livreurs" [clearable]="true">
                <ng-option *ngFor="let driver of drivers" [value]="driver.value">
                  {{driver.label}}
                </ng-option>
              </ng-select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="dateRange">Période</label>
              <input type="text" id="dateRange" class="form-control" bsDaterangepicker formControlName="dateRange" placeholder="Sélectionner...">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="row mb-3">
    <div class="col-sm-6">
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" (click)="router.navigate(['/megafast/batches/create'])">
          <i class="bx bx-plus me-1"></i> Nouveau Lot
        </button>
        <button type="button" class="btn btn-success" (click)="exportData('excel')" [disabled]="!batches.length">
          <i class="bx bx-download me-1"></i> Excel
        </button>
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bx bx-cog me-1"></i> Actions
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" (click)="bulkRecomputeStats()">
              <i class="bx bx-refresh me-2"></i>Recalculer statistiques</a></li>
            <li><a class="dropdown-item" (click)="optimizeRoutes()">
              <i class="bx bx-map me-2"></i>Optimiser routes</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-sm-6">
      <div class="text-sm-end">
        <span class="text-muted">{{totalItems}} lots trouvés</span>
      </div>
    </div>
  </div>

  <!-- Batches Grid -->
  <div class="row" *ngIf="!isLoading; else loadingTemplate">
    <div class="col-xl-4 col-lg-6" *ngFor="let batch of batches; trackBy: trackByBatchId">
      <div class="card batch-card">
        <div class="card-body">
          <!-- Header -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="card-title mb-1">{{batch.code || 'LOT-' + batch.id}}</h5>
              <span class="badge" [ngClass]="getStatusBadgeClass(batch.status)">
                {{getStatusLabel(batch.status)}}
              </span>
            </div>
            <div class="dropdown">
              <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bx bx-dots-horizontal-rounded"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" (click)="viewDetails(batch)">
                  <i class="bx bx-show me-2"></i>Voir détails</a></li>
                <li><a class="dropdown-item" (click)="router.navigate(['/megafast/batches', batch.id])">
                  <i class="bx bx-edit me-2"></i>Modifier</a></li>
                <li><hr class="dropdown-divider"></li>
                <li *ngIf="batch.status === 'planned'">
                  <a class="dropdown-item text-success" (click)="startBatch(batch.id!)">
                    <i class="bx bx-play me-2"></i>Démarrer</a></li>
                <li *ngIf="batch.status === 'in_progress'">
                  <a class="dropdown-item text-warning" (click)="completeBatch(batch.id!)">
                    <i class="bx bx-check me-2"></i>Terminer</a></li>
                <li><a class="dropdown-item" (click)="recomputeStats(batch.id!)">
                  <i class="bx bx-refresh me-2"></i>Recalculer stats</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" (click)="confirmDelete(batch.id!)">
                  <i class="bx bx-trash me-2"></i>Supprimer</a></li>
              </ul>
            </div>
          </div>

          <!-- Driver Info -->
          <div class="d-flex align-items-center mb-3">
            <div class="avatar-sm me-3">
              <div class="avatar-title rounded-circle bg-primary-subtle text-primary">
                <i class="bx bx-user"></i>
              </div>
            </div>
            <div>
              <h6 class="mb-0">{{getDriverName(batch.assignedTo)}}</h6>
              <small class="text-muted">Livreur assigné</small>
            </div>
          </div>

          <!-- Progress -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-muted">Progression</span>
              <span class="text-muted">{{getProgressPercentage(batch)}}%</span>
            </div>
            <div class="progress progress-thin">
              <div class="progress-bar"
                   [style.width.%]="getProgressPercentage(batch)"
                   [ngClass]="getProgressBarClass(batch.status)">
              </div>
            </div>
          </div>

          <!-- Stats -->
          <div class="row text-center">
            <div class="col-4">
              <div class="border-end">
                <h5 class="mb-1 text-primary">{{batch.totalShipments || 0}}</h5>
                <p class="text-muted mb-0 font-size-11">Colis</p>
              </div>
            </div>
            <div class="col-4">
              <div class="border-end">
                <h5 class="mb-1 text-success">{{batch.deliveredShipments || 0}}</h5>
                <p class="text-muted mb-0 font-size-11">Livrés</p>
              </div>
            </div>
            <div class="col-4">
              <h5 class="mb-1 text-warning">{{batch.totalAmount | currency:'TND'}}</h5>
              <p class="text-muted mb-0 font-size-11">COD</p>
            </div>
          </div>

          <!-- Footer -->
          <div class="mt-3 d-flex justify-content-between align-items-center">
            <small class="text-muted">
              <i class="bx bx-time me-1"></i>
              {{batch.createdAt?.toDate() | date:'dd/MM/yyyy'}}
            </small>
            <button class="btn btn-primary btn-sm" (click)="viewDetails(batch)">
              Voir détails
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="row justify-content-center mt-4" *ngIf="totalItems > pageSize">
    <div class="col-auto">
      <pagination
        [(ngModel)]="currentPage"
        [totalItems]="totalItems"
        [itemsPerPage]="pageSize"
        [maxSize]="5"
        [rotate]="false"
        [boundaryLinks]="true"
        (pageChanged)="onPageChanged($event)">
      </pagination>
    </div>
  </div>

  <!-- Empty State -->
  <div class="row" *ngIf="!isLoading && !batches.length">
    <div class="col-12">
      <div class="text-center p-5">
        <div class="avatar-xl mx-auto mb-4">
          <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
            <i class="bx bx-package font-size-32"></i>
          </div>
        </div>
        <h5>Aucun lot trouvé</h5>
        <p class="text-muted">Commencez par créer votre premier lot</p>
        <button class="btn btn-primary" (click)="router.navigate(['/megafast/batches/create'])">
          <i class="bx bx-plus me-1"></i> Créer un lot
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="text-center p-5">
    <output class="spinner-border text-primary" aria-label="Chargement">
      <span class="visually-hidden">Chargement...</span>
    </output>
    <p class="mt-2 text-muted">Chargement des lots...</p>
  </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<div #removeModal class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body px-4 py-5 text-center">
        <button type="button" class="btn-close position-absolute end-0 top-0 m-3"></button>
        <div class="avatar-sm mb-4 mx-auto">
          <div class="avatar-title bg-danger-subtle text-danger rounded-circle">
            <i class="bx bx-trash font-size-20"></i>
          </div>
        </div>
        <p class="text-muted font-size-16 mb-4">Êtes-vous sûr de vouloir supprimer ce lot ?</p>
        <div class="hstack gap-2 justify-content-center mb-0">
          <button type="button" class="btn btn-light">Annuler</button>
          <button type="button" class="btn btn-danger"
                  (click)="deleteBatch()"
                  [disabled]="isProcessing">
            <span *ngIf="isProcessing" class="spinner-border spinner-border-sm me-2"></span>
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
