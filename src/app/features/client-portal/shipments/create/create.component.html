<div class="container-fluid">""

  <!-- Page Title -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <h4 class="mb-sm-0 font-size-18">Nouveau Colis</h4>
        <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a [routerLink]="['/client']">Client</a></li>
            <li class="breadcrumb-item"><a [routerLink]="['/client/shipments']">Mes Colis</a></li>
            <li class="breadcrumb-item active">Nouveau</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title mb-0">Créer un nouveau colis</h4>
        </div>
        <div class="card-body">
          <form [formGroup]="shipmentForm" (ngSubmit)="onSubmit()">

            <!-- Étape 1: Informations d'expédition -->
            <div class="step-section mb-4">
              <h5 class="text-primary mb-3">
                <i class="mdi mdi-package-variant me-2"></i>
                Informations d'expédition
              </h5>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Adresse d'enlèvement</label>
                  <input type="text" class="form-control" formControlName="pickupAddress"
                         placeholder="Adresse complète d'enlèvement">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Gouvernorat d'enlèvement</label>
                  <select class="form-select" formControlName="pickupGovernorate"
                         (change)="onPickupGovernorateChange($any($event.target).value)">
                    <option value="">Sélectionner</option>
                    <option *ngFor="let gov of pickupGovernorates" [value]="gov.code">
                      {{ gov.name }}
                    </option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Délégation d'enlèvement</label>
                  <select class="form-select" formControlName="pickupDelegation">
                    <option value="">Sélectionner</option>
                    <option *ngFor="let del of pickupDelegations" [value]="del.code">
                      {{ del.name }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Étape 2: Informations du destinataire -->
            <div class="step-section mb-4">
              <h5 class="text-primary mb-3">
                <i class="mdi mdi-account me-2"></i>
                Informations du destinataire
              </h5>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Nom complet *</label>
                  <input type="text" class="form-control" formControlName="recipientName"
                         placeholder="Nom et prénom du destinataire">
                  <div *ngIf="isFieldInvalid('recipientName')" class="text-danger small mt-1">
                    Le nom du destinataire est requis
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Téléphone *</label>
                  <input type="tel" class="form-control" formControlName="recipientPhone"
                         placeholder="+216 XX XXX XXX">
                  <div *ngIf="isFieldInvalid('recipientPhone')" class="text-danger small mt-1">
                    Le téléphone est requis
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" formControlName="recipientEmail"
                         placeholder="email@example.com">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Entreprise</label>
                  <input type="text" class="form-control" formControlName="recipientCompany"
                         placeholder="Nom de l'entreprise">
                </div>
              </div>
            </div>

            <!-- Étape 3: Adresse de livraison -->
            <div class="step-section mb-4">
              <h5 class="text-primary mb-3">
                <i class="mdi mdi-map-marker me-2"></i>
                Adresse de livraison
              </h5>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Adresse ligne 1 *</label>
                  <input type="text" class="form-control" formControlName="recipientAddressLine1"
                         placeholder="Rue, numéro, bâtiment...">
                  <div *ngIf="isFieldInvalid('recipientAddressLine1')" class="text-danger small mt-1">
                    L'adresse est requise
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Adresse ligne 2</label>
                  <input type="text" class="form-control" formControlName="recipientAddressLine2"
                         placeholder="Complément d'adresse">
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Gouvernorat *</label>
                  <select class="form-select" formControlName="recipientGovernorate"
                         (change)="onDeliveryGovernorateChange($any($event.target).value)">
                    <option value="">Sélectionner un gouvernorat</option>
                    <option *ngFor="let gov of deliveryGovernorates" [value]="gov.code">
                      {{ gov.name }}
                    </option>
                  </select>
                  <div *ngIf="isFieldInvalid('recipientGovernorate')" class="text-danger small mt-1">
                    Le gouvernorat est requis
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Délégation *</label>
                  <select class="form-select" formControlName="recipientDelegation">
                    <option value="">Sélectionner une délégation</option>
                    <option *ngFor="let del of deliveryDelegations" [value]="del.code">
                      {{ del.name }}
                    </option>
                  </select>
                  <div *ngIf="isFieldInvalid('recipientDelegation')" class="text-danger small mt-1">
                    La délégation est requise
                  </div>
                </div>
              </div>
            </div>

            <!-- Étape 4: Détails du colis -->
            <div class="step-section mb-4">
              <h5 class="text-primary mb-3">
                <i class="mdi mdi-cube-outline me-2"></i>
                Détails du colis
              </h5>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Poids (kg) *</label>
                  <input type="number" class="form-control" formControlName="weight"
                         placeholder="0.0" min="0" step="0.1">
                  <div *ngIf="isFieldInvalid('weight')" class="text-danger small mt-1">
                    Le poids est requis
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Volume (m³)</label>
                  <input type="number" class="form-control" formControlName="volume"
                         placeholder="0.0" min="0" step="0.01">
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-12">
                  <label class="form-label">Notes et instructions</label>
                  <textarea class="form-control" formControlName="notes" rows="3"
                            placeholder="Instructions spéciales, notes de livraison..."></textarea>
                </div>
              </div>
            </div>

            <!-- Étape 5: Produits -->
            <div class="step-section mb-4">
              <h5 class="text-primary mb-3">
                <i class="mdi mdi-format-list-bulleted me-2"></i>
                Produits
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" (click)="addItem()">
                  <i class="mdi mdi-plus me-1"></i>Ajouter
                </button>
              </h5>

              <div formArrayName="items">
                <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i"
                     class="card card-body mb-3">
                  <div class="row align-items-center">
                    <div class="col-md-4">
                      <label class="form-label">Description *</label>
                      <input type="text" class="form-control" formControlName="description"
                             placeholder="Description du produit">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Quantité *</label>
                      <input type="number" class="form-control" formControlName="qty"
                             (change)="computeDerived()" min="1">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Prix unitaire (DT)</label>
                      <input type="number" class="form-control" formControlName="unitPrice"
                             (change)="computeDerived()" min="0" step="0.01">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Total</label>
                      <div class="form-control-plaintext fw-bold">
                        {{ (item.get('qty')?.value || 0) * (item.get('unitPrice')?.value || 0) | number:'1.2-2' }} DT
                      </div>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-sm btn-outline-danger mt-4"
                              (click)="removeItem(i)" [disabled]="items.length <= 1">
                        <i class="mdi mdi-delete"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Résumé des totaux -->
              <div class="row">
                <div class="col-md-8"></div>
                <div class="col-md-4">
                  <div class="table-responsive">
                    <table class="table table-sm table-borderless">
                      <tr>
                        <td>Quantité totale:</td>
                        <td class="text-end fw-bold">{{ totalQty }}</td>
                      </tr>
                      <tr>
                        <td>Sous-total:</td>
                        <td class="text-end fw-bold">{{ subtotal | number:'1.2-2' }} DT</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Étape 6: Paiement et frais -->
            <div class="step-section mb-4">
              <h5 class="text-primary mb-3">
                <i class="mdi mdi-cash-multiple me-2"></i>
                Paiement et frais
              </h5>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">Mode de paiement *</label>
                  <select class="form-select" formControlName="paymentMode">
                    <option value="">Sélectionner</option>
                    <option value="cod">Contre remboursement (COD)</option>
                    <option value="invoice">Facturation</option>
                  </select>
                  <div *ngIf="isFieldInvalid('paymentMode')" class="text-danger small mt-1">
                    Le mode de paiement est requis
                  </div>
                </div>
                <div class="col-md-4" *ngIf="shipmentForm.get('paymentMode')?.value === 'cod'">
                  <label class="form-label">Montant à collecter (DT) *</label>
                  <input type="number" class="form-control" formControlName="amount"
                         placeholder="0.00" min="0" step="0.01">
                  <div *ngIf="isFieldInvalid('amount')" class="text-danger small mt-1">
                    Le montant est requis pour COD
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Frais de livraison (DT)</label>
                  <input type="number" class="form-control" formControlName="deliveryFee"
                         (change)="onDeliveryFeeChange()" placeholder="0.00" min="0" step="0.01">
                </div>
              </div>

              <!-- Total final -->
              <div class="row">
                <div class="col-md-8"></div>
                <div class="col-md-4">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <tr>
                        <td>Sous-total produits:</td>
                        <td class="text-end">{{ subtotal | number:'1.2-2' }} DT</td>
                      </tr>
                      <tr>
                        <td>Frais de livraison:</td>
                        <td class="text-end">{{ shipmentForm.get('deliveryFee')?.value | number:'1.2-2' }} DT</td>
                      </tr>
                      <tr class="table-active">
                        <td class="fw-bold">Total général:</td>
                        <td class="text-end fw-bold">{{ grandTotal | number:'1.2-2' }} DT</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Boutons d'action -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <button type="button" class="btn btn-light" [routerLink]="['/client/shipments']">
                    <i class="mdi mdi-arrow-left me-1"></i>
                    Annuler
                  </button>
                  <button type="submit" class="btn btn-primary" [disabled]="shipmentForm.invalid || isSubmitting">
                    <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-1" role="status"></span>
                    <i *ngIf="!isSubmitting" class="mdi mdi-check me-1"></i>
                    {{ isSubmitting ? 'Création...' : 'Créer le colis' }}
                  </button>
                </div>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>
